import{C as e,r as t,d as n,l as i,P as s,s as a,a as o}from"./vendor.7600caef.js";var r=window.$;e.defineMode("datalog",(function(e,t){function n(e,t,n){switch(e.context=!1,"whitespace"!==n&&"comment"!==n&&(e.lastToken=t.current()),n){case"atom":return"atom";case"attribute":return"attribute";case"builtin":return"builtin";case"comment":return"comment";case"function":return"tag";case"keyword":return"keyword";case"number":return"number";case"operator":return"operator";case"string":return"string";case"variable":return"variable";case"error":return"error";case"separator":return"variable-2";case"open_paren":case"close_paren":case"whitespace":default:return null}}const i=[":-",":",".",","],s=["="],a=["("],o=/[a-z_]/,r=/[A-Z_]/,l=/[0-9]/,d=/[a-z_A-Z0-9]/,c=/[=]/,h=/[\(]/,u=/[\-\.,:]/;function m(e,t){return t.indexOf(e)>-1}function p(e,t){if(e.eatSpace())return n(t,e,"whitespace");const m=e.next();return"#"===m?(e.skipToEnd(),n(t,e,"comment")):'"'===m?function(e){return function(e,t,n){for(;!e.eol();){const i=e.next();if(i===t)return!0;i===n&&e.next()}return!1}(e,'"',"\\")}(e)?n(t,e,"string"):n(t,e,"error"):r.test(m)?(e.eatWhile(d),n(t,e,"variable")):o.test(m)?(e.eatWhile(d),e.current(),"("===e.peek()?n(t,e,"function"):n(t,e,"atom")):l.test(m)?(e.eatWhile(l),n(t,e,"number")):g(e,h,a)?(v(t,e),n(t,e,"open_paren")):g(e,/\)/,[")"])?(v(t,e),n(t,e,"close_paren")):y(e,u,i)?(!1===t.context&&v(t,e),n(t,e,"separator")):y(e,c,s)?n(t,e,"operator"):y(e,/\?/,["?"])?n(t,e,"keyword"):y(e,/\~/,["~"])?n(t,e,"builtin"):n(t,e,null)}function g(e,t,n){if(1===e.current().length&&t.test(e.current())){for(e.backUp(1);t.test(e.peek());)if(e.next(),m(e.current(),n))return!0;e.backUp(e.current().length-1)}return!1}function y(e,t,n){if(1===e.current().length&&t.test(e.current())){for(;t.test(e.peek());)e.next();for(;e.current().length>0;){if(m(e.current(),n))return!0;e.backUp(1)}e.next()}return!1}function b(e){this.token=e?e.current():"",this.column=e?e.column():0,this.indent=e?e.indentation():0}function f(e){return e.tokenStack.pop()}function w(e,t){const n=e.tokenStack.length,i=t||1;return n<i?new b:e.tokenStack[n-i]}function v(e,t){const n=t.current(),i=w(e).token;return","!==n&&(function(e,t){switch(e+" "+t){case"( )":return!0;default:return!1}}(i,n)?(f(e),!1):function(e,t){switch(e+" "+t){case":- .":return!0;default:return!1}}(i,n)?(f(e),v(e,t)):(e.tokenStack.push(new b(t)),!0))}return{startState:function(){return{tokenStack:[],context:!1,lastToken:null}},token:function(e,t){return p(e,t)},indent:function(t,n){return function(t,n){const i=e.indentUnit,s=w(t).token;return function(e,t){const n=e.match(t);n&&e.slice(0,n.index)}(n,/[^a-z]/),m(s,a)?w(t).column+s.length:"."===s||""===s?0:":-"===s?w(t).indent+i:w(t).column+i}(t,n)}}}));let l,d;l="http://localhost:8888",d="localhost:8888";const c={statement:l+"/v1/statement",statementsocket:"ws://"+d+"/v1/statementsocket",status:l+"/v1/status",atlas:l+"/v1/atlas",engines:l+"/v1/engines",symbols:l+"/v1/symbol",downloads:l+"/v1/download",figure:l+"/v1/figure"},h="<class 'neurolang.frontend.neurosynth_utils.StudyID'>",u="<class 'neurolang.regions.ExplicitVBR'>",m="<class 'neurolang.regions.ExplicitVBROverlay'>",p="<class 'matplotlib.figure.Figure'>",g=[{name:"red",data:[[0,.96,.26,.21],[1,.96,.26,.21]],gradation:!1,hex:"#f44336"},{name:"pink",data:[[0,.91,.12,.39],[1,.91,.12,.39]],gradation:!1,hex:"#e91e63"},{name:"deep purple",data:[[0,.4,.23,.72],[1,.4,.23,.72]],gradation:!1,hex:"#673ab7"},{name:"indigo",data:[[0,.25,.32,.71],[1,.25,.32,.71]],gradation:!1,hex:"#3f51b5"},{name:"blue",data:[[0,.13,.59,.95],[1,.13,.59,.95]],gradation:!1,hex:"#2196f3"},{name:"cyan",data:[[0,0,.74,.83],[1,0,.74,.83]],gradation:!1,hex:"#00bcd4"},{name:"teal",data:[[0,0,.59,.53],[1,0,.59,.53]],gradation:!1,hex:"#009688"},{name:"green",data:[[0,.3,.69,.31],[1,.3,.69,.31]],gradation:!1,hex:"#4caf50"},{name:"lime",data:[[0,.8,.86,.22],[1,.8,.86,.22]],gradation:!1,hex:"#cddc39"},{name:"yellow",data:[[0,1,.92,.23],[1,1,.92,.23]],gradation:!1,hex:"#ffeb3b"},{name:"orange",data:[[0,1,.6,0],[1,1,.6,0]],gradation:!1,hex:"#ff9800"},{name:"blue gray",data:[[0,.38,.49,.55],[1,.38,.49,.55]],gradation:!1,hex:"#607d8b"}],y=["YlOrRd","YlGnBu","Cividis","Greens","Viridis","Purples","Cool","Warm"].map((e=>function(e){const n=9,i=w(e,n).colors.map(((e,i)=>{const s=t(e);return[i/(n-1),s.r/255,s.g/255,s.b/255]}));return{name:e,data:i,gradation:!0}}(e)));const b=new class{constructor(){this.cache={}}remove(e){delete this.cache[e]}exists(e){return!!this.cache[e]}get(e){return this.cache[e]}set(e,t,n){delete this.cache[e],this.cache[e]=t,void 0!==n&&n(t)}};class f{constructor(e){this.atlasKey=e,this.imageIds=[],this.resultsContainer=r("#symbolsContainer"),this.papayaContainer=r("#nlPapayaContainer"),this.cbContainer=r("#nlColorbarContainer"),this.usedColorTables=[]}showViewer(){r(".nl-papaya-alert").hide(),b.exists(this.atlasKey)?(this.resultsContainer.width("50%"),this.papayaContainer.is(":hidden")?this.papayaContainer.show(500,(()=>this._initViewer())):this._initViewer()):r.get(c.atlas).done((e=>{b.set(this.atlasKey,e.data.image),this.resultsContainer.width("50%"),this.papayaContainer.is(":hidden")?this.papayaContainer.show(500,(()=>this._initViewer())):this._initViewer()}))}hideViewer(e=500){this.papayaContainer.hide(e),this.resultsContainer.width("100%")}_initParams(){const e=[];e.worldSpace=!0,e.kioskMode=!0,e.showControlBar=!0,e.showImageButtons=!1,e.luts=y.concat(...g),this.params=e}_initViewer(){this.atlasImage=b.get(this.atlasKey),this._initParams(),window.atlas=this.atlasImage,this.params.encodedImages=["atlas"],0===papayaContainers.length?papaya.Container.addViewer("nlPapayaParent",this.params):(papaya.Container.resetViewer(0,this.params),this.cbContainer.empty()),this.imageIds=["atlas"],this.usedColorTables=[]}addImage(e,t,n,i,s){let a=null;if(this.canAdd()){window[e]=t;const o=this._getImageParams(e,t,n,i,s);papaya.Container.addImage(0,e,o),this.imageIds.push(e),a=o[e],this.usedColorTables.push(a.lut),this.showColorBar(e)}return a}removeImage(e){const t=this.imageIds.indexOf(e);if(t>-1){const n=this.usedColorTables.indexOf(papayaContainers[0].viewer.screenVolumes[t].lutName);papaya.Container.removeImage(0,t),this.imageIds.splice(t,1),this.hideColorBar(e),n>-1&&this.usedColorTables.splice(n,1)}}canAdd(){return this.imageIds.length-1<8}imageIndex(e){return this.imageIds.indexOf(e)}setCoordinates(e){papayaContainers[0].viewer.gotoWorldCoordinate(new papaya.core.Coordinate(e[0],e[1],e[2]),!1)}onImageLoaded(){}showColorBar(e){this.cbContainer.find(".nl-color-bar").hide(),this.cbContainer.find("#cb_"+e).show()}hideColorBar(e){this.cbContainer.find("#cb_"+e).hide()}showImageHistogram(e){const t=this.imageIndex(e),n=[{x:papayaContainers[0].viewer.screenVolumes[t].volume.imageData.data.filter((e=>0!==e)),type:"histogram"}];s.newPlot("nlHistogramContainer",n,{title:"Histogram of non-zero image data",showlegend:!1,width:380,height:380})}_getImageParams(e,t,n,i,s){const a={};if(void 0!==n&&void 0!==i&&n===i){const e=this._getNextColorTable(!0);a.lut=e.name,a.hex=e.hex,a.alpha=.8}else{void 0!==i&&(a.max=Number(i.toFixed(4))),void 0!==s?a.min=Number(s.toFixed(4)):void 0!==n&&(a.min=Number(n.toFixed(4)));const t=this._getNextColorTable(!1);a.lut=t.name,a.loadingComplete=()=>this.onImageLoaded();(function(e,t,n,i,s,a,o,l=256){const{colors:d,dark0:c,dark1:h}=w(n,l),u=v(d,l),m=r(`<div class="ui mini transparent labeled input">\n  <div class="ui label" data-content="Minimum non-zero image value">${Number(i.toFixed(3))}</div>\n  <input class="nl-min-threshold" type="number" step="0.001" value=${Number(a.toFixed(3))}\n  data-name=${t} data-content="Minimum displayed value"></div>`);h&&m.addClass("inverted");m.find(".ui.label").popup(),m.find("input").popup();const p=r(`<div class="ui mini transparent right labeled input">\n  <input class="nl-max-threshold" type="number" step="0.001" value=${Number(o.toFixed(3))}\n  data-name=${t} data-content="Maximum displayed value">\n  <div class="ui label" data-content="Maximum image value">${Number(s.toFixed(3))}</div></div>`);c&&p.addClass("inverted");p.find(".ui.label").popup(),p.find("input").popup();const g=r(`<div class="nl-color-bar" id="cb_${t}"></div>`);return g.append(m.get()),g.append(u),g.append(p.get()),e.find("#cb_"+t).remove(),e.append(g.get()),g})(this.cbContainer,e,t.name,n,i,s,i).find("input").on("change",(e=>this.onThresholdChange(e)))}const o=[];return o[e]=a,o}onThresholdChange(e){const t=r(e.target),n=t.data("name"),i=t.val(),s=t.hasClass("nl-min-threshold"),a=this.imageIds.indexOf(n),o=papayaContainers[0].viewer.screenVolumes[a];s?o.screenMin=i:o.screenMax=i,papayaContainers[0].viewer.drawViewer(!0,!1)}_getNextColorTable(e){const t=e?g:y;for(const n of t)if(this.usedColorTables.indexOf(n.name)<0)return n}}function w(e,s){let a,o,r;if(n[`scheme${e}`]&&n[`scheme${e}`][s])a=n[`scheme${e}`][s],o=i(a[0]).l<50,r=i(a[a.length-1]).l<50;else{const l=n[`interpolate${e}`];a=[],o=i(l(0)).l<50,r=i(l(1)).l<50;for(let e=0;e<s;++e)a.push(t(l(e/(s-1))).hex())}return{colors:a.reverse(),dark0:o,dark1:r}}function v(e,t){const n=document.createElement("canvas");n.width=t,n.height=1;const i=n.getContext("2d");n.style.margin="0",n.style.width="100%";for(let s=0;s<t;++s)i.fillStyle=e[s],i.fillRect(s,0,1,1);return n}class C{constructor(){this.results=void 0,this.activeSymbol=void 0,this.tableData=void 0,this.resultsContainer=r("#symbolsContainer"),this.dropdown=this.resultsContainer.find(".nl-symbols-dropdown"),this.tabTable=this.resultsContainer.find(".nl-symbols-table"),this.functionsHelp=this.resultsContainer.find(".nl-functions-msg"),this.symbolsHelp=this.resultsContainer.find(".nl-symbols-help"),this.symbolsDownload=this.resultsContainer.find(".nl-symbols-download"),this.tabTable.off("draw.dt").on("draw.dt",(()=>this.onTableDraw())),this.dropdown.dropdown(),this.dropdown.find("input").on("change",(e=>this.onSymbolChange(e))),this.symbolsHelp.popup(),this.viewer=new f}setQueryResults(e){this.resultsContainer.show(),this.results=e.data,this._updateSymbolsList()}hide(){this.resultsContainer.hide(),this.viewer.hideViewer(0)}setRouteEngine(e){this.results=void 0,this.engine=e,r.ajax({url:`${c.symbols}/${e}`,type:"get"}).done((t=>{"status"in t&&"ok"===t.status&&t.data.done&&!("errorName"in t.data)?(this.resultsContainer.show(),this.symbols=t.data,this._updateSymbolsList()):(this.symbols=void 0,console.log("An error occurred while fetching symbols for engine "+e),console.log(t),this.hide())}))}_updateSymbolsList(){const e=this.dropdown.find(".menu");e.empty();let t=null,n=[];if(this.results){n=Object.keys(this.results.results),n.sort();const i=n.map((e=>this.results.results[e].probabilistic?"probabilistic":""));$(e,n,"Query symbols","symbol query-symbol",i),t=n.find((e=>this.results.results[e].last_parsed_symbol)),t||(t=n[0])}if(this.symbols){const i=Object.keys(this.symbols.results).filter((e=>this.symbols.results[e].function)),s=Object.keys(this.symbols.results).filter((e=>this.symbols.results[e].command)),a=Object.keys(this.symbols.results).filter((e=>!this.symbols.results[e].function&&!this.symbols.results[e].command&&n.indexOf(e)<0));a.length>0&&($(e,a,"Base symbols","symbol base-symbol"),t=t||a[0]),i.length>0&&($(e,i,"Functions","function"),t=t||i[0]),s.length>0&&($(e,s,"Commands","command"),t=t||s[0])}this.dropdown.dropdown("refresh");const i=this.dropdown.dropdown("get value");this.dropdown.dropdown("set selected",t),i===t&&this.onSymbolChange()}onSymbolChange(e){this.activeSymbol=e?e.target.value:this.activeSymbol;const t=this.results&&this.activeSymbol in this.results.results,n=t?this.results.results[this.activeSymbol]:this.symbols.results[this.activeSymbol];if("function"in n&&n.function||"command"in n&&n.command)this.setFunctionHelp("",`A ${n.function?"function":"command"} of type ${n.type}`,this.activeSymbol,n.doc),this.tabTable.parents("div.dataTables_wrapper").first().hide(),this.viewer.hideViewer();else{r.fn.DataTable.isDataTable(this.tabTable)&&(this.tabTable.DataTable().destroy(),this.tabTable.empty()),this.tabTable.parents("div.dataTables_wrapper").first().show(),this.functionsHelp.hide();const e=n.columns.map(((e,t)=>{const i={title:e};return n.row_type[t]===h?i.render=k:n.row_type[t]===m||n.row_type[t]===u?i.render=x:n.row_type[t]===p&&(i.render=_),i}));this.tabTable.DataTable({processing:!0,serverSide:!0,pageLength:25,order:[],searching:!1,columns:e,ajax:(e,t,n)=>this.fetchNewTableData(e,t,n)});const i=n.row_type.some((e=>e===m||e===u));i?this.viewer.showViewer():this.viewer.hideViewer(),t&&!i?(this.symbolsDownload.show(),this.symbolsDownload.attr("href",`${c.downloads}/${this.results.uuid}?symbol=${this.activeSymbol}`)):this.symbolsDownload.hide()}}fetchNewTableData(e,t,n){const i={symbol:this.activeSymbol,start:e.start,length:e.length};"order"in e&&e.order.length>0&&(i.sort=e.order[0].column,i.asc=+("asc"===e.order[0].dir));const s=this.results&&this.activeSymbol in this.results.results?`${c.status}/${this.results.uuid}`:`${c.symbols}/${this.engine}`;r.ajax({url:s,type:"get",data:i}).done((n=>{this.tableData=n.data;const i={draw:e.draw,recordsTotal:n.data.results[this.activeSymbol].size,recordsFiltered:n.data.results[this.activeSymbol].size,data:n.data.results[this.activeSymbol].values};t(i)}))}setFunctionHelp(e,t,n,i){const s=this.functionsHelp.find(".nl-functions-header");void 0!==n?s.text(n):s.empty();const a=this.functionsHelp.find(".nl-functions-message");void 0!==t?a.text(t):a.empty();const o=this.functionsHelp.find(".nl-functions-help");void 0!==i?(o.text(i),o.show()):(o.empty(),o.hide()),this.functionsHelp.removeClass("info error warning success"),this.functionsHelp.addClass(e),this.functionsHelp.show()}onTableDraw(){r(".nl-vbr-overlay-switch input").on("change",(e=>this.onImageSwitchChanged(e))),r(".nl-vbr-overlay-center").on("click",(e=>this.onImageCenterClicked(e))),r(".nl-vbr-overlay-hist").on("click",(e=>this.onShowHistogramClicked(e))),r(".nl-vbr-overlay-hist").popup({on:"manual",html:'<div id="nlHistogramContainer" class="nl-histogram-container"></div>',position:"top center",lastResort:"top center"}),r(".nl-image-download").on("click",(e=>this.onImageDownloadClicked(e))),r(".nl-mini-colorbar").on("click",(e=>this.onMiniColorBarClicked(e))),r(".nl-mini-colorbar").popup(),r(".nl-mplt-figure-toggle").on("click",(e=>this.onShowFigureClicked(e))),r(".nl-mplt-figure-toggle").popup({on:"manual",html:'<div id="nlMpltFigureContainer" class="nl-mplt-figure-container"><div class="ui active inverted dimmer"><div class="ui text loader">Loading</div></div></div>',position:"right center",lastResort:"right center"})}onImageSwitchChanged(e){const t=r(e.target),n=t.parent().parent(),i=t.data("col"),s=t.data("row"),a=`image_${s}_${i}`,o=this.tableData.results[this.activeSymbol].values[s][i];if(r("#nlPapayaContainer .nl-papaya-alert").hide(),e.target.checked)if(this.viewer.canAdd()){const e=this.viewer.addImage(a,o.image,o.min,o.max,o.q95);if("hex"in e)t.siblings("label").attr("style","color: "+e.hex+" !important"),n.addClass("region-label");else{const n=t.parents(".nl-vbr-overlay-controls").find(".nl-mini-colorbar"),i=v(w(e.lut,128).colors,128);i.style.height="100%",n.empty(),n.append(i)}n.addClass("displayed")}else r("#nlPapayaContainer .nl-papaya-alert").show(),e.target.checked=!1;else this.viewer.removeImage(a),t.siblings("label").attr("style",""),n.removeClass("displayed")}onShowHistogramClicked(e){let t=r(e.target);t.is("i")&&(t=t.parent());const n=t.data("col"),i=`image_${t.data("row")}_${n}`,s=t.popup("is visible");t.popup("toggle"),s||this.viewer.showImageHistogram(i)}onImageCenterClicked(e){let t=r(e.target);t.is("i")&&(t=t.parent());const n=t.data("col"),i=t.data("row"),s=this.tableData.results[this.activeSymbol].values[i][n];this.viewer.setCoordinates(s.center)}onImageDownloadClicked(e){const t=r(e.target).parents(".nl-image-download"),n=t.data("idx"),i=t.data("col");let s=this.results&&this.activeSymbol in this.results.results?`${c.downloads}/${this.results.uuid}`:`${c.downloads}/${this.engine}`;s+=`?symbol=${this.activeSymbol}&col=${i}&idx=${n}`,t.attr("href",s)}onMiniColorBarClicked(e){let t=r(e.target);t.is("canvas")&&(t=t.parent());const n=t.data("col"),i=`image_${t.data("row")}_${n}`;this.viewer.showColorBar(i)}onShowFigureClicked(e){let t=r(e.target);t.is("i")&&(t=t.parent());const n=t.data("row"),i=t.data("col"),s=t.popup("is visible");if(t.popup("toggle"),!s){let e=this.results&&this.activeSymbol in this.results.results?`${c.figure}/${this.results.uuid}`:`${c.figure}/${this.engine}`;e+=`?symbol=${this.activeSymbol}&col=${i}&row=${n}`,r.get(e).done((t=>{const n=r("#nlMpltFigureContainer");n.append(t.documentElement),n.find(".active.dimmer").removeClass("active"),e+="&format=png";const i=r(`<a href="${e}" class="nl-figure-download">\n          <button class="ui tiny circular icon basic button" data-tooltip="Download figure">\n          <i class="download icon"></i></button></a>`);n.append(i)}))}}}function k(e,t){return"display"===t?`<a class="nl-pmid-link" href="https://www.ncbi.nlm.nih.gov/pubmed/?term=${e}" target="_blank">PubMed:${e}</a>`:e}function x(e,t,n,i){if("object"==typeof e&&"image"in e){if("display"===t){return`<div class="nl-vbr-overlay-controls">\n      <div class="ui toggle checkbox nl-vbr-overlay-switch">\n      <input type="checkbox" data-row=${i.row} data-col=${i.col}>\n      <label>Show region</label></div>\n      <div class="nl-mini-colorbar" data-content="Display the colorbar for this image"\n      data-row=${i.row} data-col=${i.col}></div>\n      <button class="ui tiny icon button nl-vbr-overlay-center nl-overlay-control"\n      data-row=${i.row} data-col=${i.col} data-tooltip="Center on region">\n      <i class="crosshairs icon"></i></button>\n      <button class="ui tiny icon button nl-vbr-overlay-hist nl-overlay-control"\n      data-row=${i.row} data-col=${i.col} data-tooltip="Show image histogram">\n      <i class="chart bar outline icon"></i></button>\n      <a href="#" class="nl-image-download" data-idx=${e.idx} data-col=${i.col}>\n      <button class="ui tiny circular icon button" data-tooltip="Download image file">\n      <i class="download icon"></i></button></a></div>\n      `}return e.hash}return e}function _(e,t,n,i){if("display"===t){return`<div class="nl-mplt-figure-controls">\n      <img class="ui tiny bordered image nl-mplt-figure-toggle nl-figure-control"\n      src="data:image/png;base64, ${e}" data-row=${i.row} data-col=${i.col} data-tooltip="Show figure">\n      </div>`}return e}function $(e,t,n,i,s){e.append(r('<div class="divider"></div>')),e.append(r(`<div class="header">${n}</div>`)),e.append(r('<div class="divider"></div>')),t.forEach(((t,n)=>{const a=r(`<div class="item ${i}" data-value="${t}">${t}</div>`);s&&a.addClass(s[n]),e.append(a)}))}o(window,r);const S=new class{constructor(){this.engine="destrieux",this.queryTextArea=document.querySelector("#queryTextArea"),this.editor=e.fromTextArea(this.queryTextArea,{mode:"datalog",theme:"xq-light",autoRefresh:!0,lineNumbers:!0,lineWrapping:!0,gutters:["CodeMirror-linenumbers",{className:"marks",style:"width: .9em"}]}),this.runQueryBtn=r("#runQueryBtn"),this.queryAlert=r("#queryAlert"),this.runQueryBtn.on("click",(()=>this._submitQuery())),this.inputFileReader=r("#queryFileInput"),this.inputFileReader.on("change",(()=>this._loadCodeAsFile())),this.downloadLink=r(".nl-query-download"),this.downloadLink.on("click",(()=>this._saveCodeAsFile())),r(".nl-query-upload").on("click",(e=>{this.inputFileReader.trigger("click"),e.preventDefault()})),this.sc=new C}setRouteEngine(e,t){this.engine=e,this.editor.setValue(t),this._clearAlert(),this.sc.hide(),this.sc.setRouteEngine(e)}_submitQuery(){const e=this.editor.getValue().trim();if(e){const t={query:e};this.engine&&(t.engine=this.engine),this.socket=new WebSocket(c.statementsocket),this.socket.onerror=this._onerror,this.socket.onmessage=e=>this._onmessage(e),this.socket.onopen=()=>{this.runQueryBtn.addClass("loading"),this.runQueryBtn.prop("disabled",!0),this.socket.send(JSON.stringify(t))}}}_onerror(e){this._setAlert("warning","An error occured while connecting to the server.")}_onmessage(e){const t=JSON.parse(e.data);if("status"in t&&"ok"===t.status)if(t.data.cancelled)this._setAlert("warning",void 0,"The query was cancelled."),this._finishQuery();else if(t.data.done)if("errorName"in t.data){this._clearAlert();const e="errorDoc"in t.data?t.data.errorDoc:void 0;this._setAlert("error",t.data.message,t.data.errorName,e),"line_info"in t.data&&this._setEditorMarks(t.data.line_info),this._finishQuery()}else this._clearAlert(),this._finishQuery(),this.sc.setQueryResults(t);else this._setAlert("info","Results will display below when available..","Your query is running");else this._setAlert("error",t,"An error occured while submitting your query."),this._finishQuery()}_finishQuery(){this.socket.close(),this.runQueryBtn.removeClass("loading"),this.runQueryBtn.prop("disabled",!1)}_setEditorMarks(e){const t={line:e.line,ch:0===e.col?0:e.col-1},n={line:e.line,ch:e.col+1},i=r(`<div data-position="bottom center" data-content="${e.text}">❌</div>`);i.css("color","#822"),i.popup(),this.editor.setGutterMarker(e.line,"marks",i[0]),this.editor.markText(t,n,{css:"text-decoration: red double underline; text-underline-offset: .3em;"})}_saveCodeAsFile(){this.downloadLink.attr("href","data:text/plain;charset=utf-8,"+encodeURIComponent(this.editor.getValue())),this.downloadLink.attr("download","export.neurolang")}_loadCodeAsFile(){const e=new FileReader;e.onload=e=>{this.editor.setValue(e.target.result)},e.onerror=e=>{r("body").toast({class:"error",message:"An error occured while reading your file !"})},e.readAsText(this.inputFileReader.get(0).files[0])}_setAlert(e,t,n,i){const s=this.queryAlert.find(".nl-query-header");void 0!==n?s.text(n):s.empty();const a=this.queryAlert.find(".nl-query-message");void 0!==t?a.text(t):a.empty();const o=this.queryAlert.find(".nl-query-help");void 0!==i?(o.text(i),o.show()):(o.empty(),o.hide()),this.queryAlert.removeClass("info error warning success"),this.queryAlert.addClass(e),this.queryAlert.show()}_clearAlert(){this.queryAlert.hide(),this.editor.clearGutter("marks"),this.editor.getAllMarks().forEach((e=>e.clear()))}},T=new class{constructor(e){this.engine=null,this.queryId=null,this.qc=e,this.engines=null,this.ready=!1,this.init()}init(){r.get(c.engines).done((e=>{"status"in e&&"ok"===e.status?(this.engines=e.data,this.initEnginesMenu(),this.ready=!0,this.onRouteEngineChange()):this.onFail()})).fail((()=>this.onFail()));r(".nl-query-info").accordion()}onFail(){this.engines=void 0,console.log("An error occurred while fetching the list of engines."),r(".nl-server-error-modal").modal("show")}setRouteEngine(e){this.engine=e.engine,this.queryId=e.queryId,this.ready&&this.onRouteEngineChange()}onRouteEngineChange(){let e=this.engines.find((e=>e.engine===this.engine));e||(e=this.engines[0]);let t=e.queries.find((e=>e.id===this.queryId));t||(t=e.queries[0]),this.qc.setRouteEngine(e.engine,t.query),this.updateQueryHelp(t)}initEnginesMenu(){const e=r(".nl-dataset-dropdown");e.empty();for(const t of this.engines){const n=r(`<a class="item" href="/${t.engine}" data-link></a>`);if("queries"in t&&t.queries.length>1){r('<i class="dropdown icon"></i>').appendTo(n),r(`<span class="text">${t.engine}</span>`).appendTo(n);const e=r('<div class="menu"></div>');t.queries.forEach(((n,i)=>{r(`<a class="item" href="/${t.engine}/${n.id}" data-link>${n.shortTitle}</a>`).appendTo(e)})),e.appendTo(n)}else n.text(t.engine);e.append(n)}r(".main.menu  .ui.dropdown").dropdown({on:"hover"})}updateQueryHelp(e){r(".nl-query-info .nl-query-title").text(e.title);const t=r(".nl-query-info .nl-query-description");if("description"in e&&e.description){const n=new a.Converter;t.html(n.makeHtml(e.description))}else t.html("")}}(S),q=[{path:"/:engine/:queryId",onRouteChange:e=>T.setRouteEngine(e)},{path:"/:engine",onRouteChange:e=>T.setRouteEngine(e)},{path:"/",onRouteChange:e=>T.setRouteEngine(e)}];new class{constructor(e){this.routes=e,this._init()}_init(){window.addEventListener("popstate",(()=>this.route())),document.addEventListener("DOMContentLoaded",(()=>{document.body.addEventListener("click",(e=>{const t=e.target.closest("[data-link]");t&&(e.preventDefault(),this.navigateTo(t.href))})),this.route()}))}navigateTo(e){history.pushState(null,null,e),this.route()}async route(){let e=this.routes.map((e=>{return{route:e,result:location.pathname.match((t=e.path,new RegExp("^"+t.replace(/\//g,"\\/").replace(/:\w+/g,"(.+)")+"$")))};var t})).find((e=>null!==e.result));e||(e={route:this.routes[0],result:[location.pathname]}),e.route.onRouteChange((e=>{const t=e.result.slice(1),n=Array.from(e.route.path.matchAll(/:(\w+)/g)).map((e=>e[1]));return Object.fromEntries(n.map(((e,n)=>[e,t[n]])))})(e))}}(q);
